# ðŸ”¬ Malware Analysis Guide - Honeypot to Kali Sandbox

## Overview

This guide shows how to safely extract malicious payloads captured by your Cowrie honeypot and analyze them in an isolated Kali Linux VirtualBox environment.

---

## âš ï¸ Critical Safety Rules

**NEVER:**
- âŒ Run malware on your host machine
- âŒ Run malware on a VM with network access
- âŒ Extract files without verifying sandbox isolation
- âŒ Share malware samples without proper encryption
- âŒ Execute payloads without snapshot/backup

**ALWAYS:**
- âœ… Use isolated VM with network disabled
- âœ… Take VM snapshot before analysis
- âœ… Use `--no-execute` flags when testing
- âœ… Encrypt samples during transfer
- âœ… Document everything (hashes, behavior, IOCs)

---

## ðŸ—ï¸ Part 1: VirtualBox Isolation Setup

### Step 1: Configure Kali VM for Isolation

```bash
# In VirtualBox Manager:
# 1. Select your Kali VM
# 2. Settings â†’ Network
# 3. Adapter 1: Set to "Host-only Adapter" or "Internal Network"
# 4. DISABLE all other adapters
# 5. Apply and close

# Verify no internet in Kali VM:
ping -c 3 8.8.8.8  # Should fail
curl https://google.com  # Should fail
```

### Step 2: Create Analysis Snapshot

```bash
# Power off Kali VM completely
VBoxManage snapshot "Kali-Analysis" take "clean-baseline" \
  --description "Clean state before malware analysis"

# Or use VirtualBox GUI:
# Machine â†’ Take Snapshot â†’ Name: "clean-baseline"
```

### Step 3: Install Analysis Tools in Kali

```bash
# Update Kali (while still on network, then disconnect)
sudo apt update && sudo apt upgrade -y

# Install analysis tools
sudo apt install -y \
  python3-pip \
  binwalk \
  foremost \
  xxd \
  hexedit \
  strings \
  file \
  radare2 \
  ghidra \
  wireshark \
  tcpdump \
  volatility3 \
  yara \
  clamav \
  clamav-daemon

# Install Python analysis tools
pip3 install \
  pefile \
  oletools \
  pyelftools \
  capstone \
  unicorn \
  angr \
  pwntools

# Update ClamAV signatures (before disconnecting network)
sudo freshclam

# NOW DISCONNECT NETWORK (see Step 1)
```

---

## ðŸ“¦ Part 2: Extract Payloads from Cowrie

### Understanding Cowrie File Storage

Cowrie stores downloaded files in:
```
/opt/cowrie/var/lib/cowrie/downloads/
```

Files are named by their SHA256 hash.

### Step 1: SSH to Honeypot and List Downloads

```bash
# Connect to honeypot
ssh -i ~/.ssh/gmu-honeypot-key.pem ec2-user@44.218.220.47

# List downloaded files
sudo ls -lh /opt/cowrie/var/lib/cowrie/downloads/

# Get details about recent downloads
sudo find /opt/cowrie/var/lib/cowrie/downloads/ -type f -mtime -7 -ls

# Check file types
cd /opt/cowrie/var/lib/cowrie/downloads/
for file in *; do 
  echo "=== $file ==="
  file "$file"
  sha256sum "$file"
done
```

### Step 2: Identify Malicious Downloads from Logs

```bash
# Find download events in Cowrie logs
sudo jq -r 'select(.eventid=="cowrie.session.file_download") | 
  {timestamp, src_ip, url: .url, shasum: .shasum, outfile: .outfile}' \
  /opt/cowrie/var/log/cowrie/cowrie.json | tail -20

# Get specific download by SHA256
SHA="abc123def456..."  # Replace with actual hash
sudo jq -r "select(.shasum==\"$SHA\")" \
  /opt/cowrie/var/log/cowrie/cowrie.json

# Find all commands executed after download
sudo jq -r 'select(.eventid=="cowrie.command.input") | 
  {timestamp, src_ip, input: .input}' \
  /opt/cowrie/var/log/cowrie/cowrie.json | tail -50
```

### Step 3: Package Samples Securely

```bash
# Create analysis package with metadata
ANALYSIS_DATE=$(date +%Y%m%d)
PACKAGE_DIR="/tmp/malware-analysis-$ANALYSIS_DATE"
mkdir -p "$PACKAGE_DIR/samples" "$PACKAGE_DIR/metadata"

# Copy samples (replace with actual hashes you want)
cd /opt/cowrie/var/lib/cowrie/downloads/
for hash in abc123def456 def456abc789; do
  if [ -f "$hash" ]; then
    sudo cp "$hash" "$PACKAGE_DIR/samples/"
    
    # Generate metadata
    echo "File: $hash" > "$PACKAGE_DIR/metadata/$hash.txt"
    file "$hash" >> "$PACKAGE_DIR/metadata/$hash.txt"
    sha256sum "$hash" >> "$PACKAGE_DIR/metadata/$hash.txt"
    md5sum "$hash" >> "$PACKAGE_DIR/metadata/$hash.txt"
    stat "$hash" >> "$PACKAGE_DIR/metadata/$hash.txt"
    
    # Extract source info from logs
    sudo jq -r "select(.shasum==\"$hash\")" \
      /opt/cowrie/var/log/cowrie/cowrie.json \
      > "$PACKAGE_DIR/metadata/$hash.json"
  fi
done

# Create encrypted archive (password: infected)
cd /tmp
zip -P infected -r "malware-package-$ANALYSIS_DATE.zip" "malware-analysis-$ANALYSIS_DATE/"

# Set secure permissions
chmod 600 "malware-package-$ANALYSIS_DATE.zip"

echo "Package created: /tmp/malware-package-$ANALYSIS_DATE.zip"
echo "Password: infected"
```

---

## ðŸ”„ Part 3: Transfer to Kali (Safely)

### Method 1: SCP via Host (Recommended)

```bash
# On EC2 honeypot - download to your laptop first
# From your laptop:
scp -i ~/.ssh/gmu-honeypot-key.pem \
  ec2-user@44.218.220.47:/tmp/malware-package-*.zip \
  ~/Downloads/

# Then copy to Kali via shared folder or SCP
# If Kali has temporary network access:
scp ~/Downloads/malware-package-*.zip kali@kali-vm-ip:~/analysis/

# OR use VirtualBox shared folder:
# VirtualBox â†’ Settings â†’ Shared Folders â†’ Add
# Host Path: /path/to/Downloads
# Guest Path: /media/sf_downloads
# Auto-mount: Yes
# Then in Kali:
sudo usermod -aG vboxsf $(whoami)
# Logout/login, then:
cp /media/sf_downloads/malware-package-*.zip ~/analysis/
```

### Method 2: Base64 Encode (For Small Files)

```bash
# On honeypot
base64 /tmp/malware-package-*.zip > /tmp/malware.b64
cat /tmp/malware.b64  # Copy to clipboard

# In Kali (paste clipboard into file)
cat > ~/analysis/malware.b64 << 'EOF'
[paste base64 content here]
EOF

# Decode
base64 -d ~/analysis/malware.b64 > ~/analysis/malware-package.zip
```

---

## ðŸ” Part 4: Analysis in Kali (Network Disabled!)

### Initial Triage

```bash
# In Kali VM (verify network is disabled first!)
ping -c 1 8.8.8.8  # Should fail

cd ~/analysis
mkdir -p samples metadata reports

# Extract package (password: infected)
unzip -P infected malware-package-*.zip

# Move samples
cd malware-analysis-*/samples
```

### Static Analysis

```bash
# 1. Basic file identification
for file in *; do
  echo "=== Analyzing: $file ==="
  
  # File type
  file "$file"
  
  # Hashes
  md5sum "$file"
  sha1sum "$file"
  sha256sum "$file"
  
  # Size and entropy (high entropy = encrypted/packed)
  ls -lh "$file"
  ent "$file"
  
  # Strings (look for URLs, IPs, commands)
  strings "$file" | grep -E "(http|ftp|wget|curl|bash|sh|/tmp)" | head -20
  
  # Check for embedded files
  binwalk "$file"
  
  echo ""
done > ~/analysis/reports/static-analysis.txt
```

### Hash Lookup (Requires Brief Network)

```bash
# ONLY IF YOU TEMPORARILY ENABLE NETWORK IN KALI:
# Re-enable network adapter in VirtualBox
# Settings â†’ Network â†’ Enable Adapter 1 â†’ NAT

# Check VirusTotal (use your API key)
VT_KEY="your_virustotal_key_here"
FILE_HASH="abc123def456..."

curl -s "https://www.virustotal.com/api/v3/files/$FILE_HASH" \
  -H "x-apikey: $VT_KEY" | jq .

# Or use online services manually:
# - VirusTotal: https://www.virustotal.com/
# - Hybrid Analysis: https://www.hybrid-analysis.com/
# - ANY.RUN: https://any.run/

# IMMEDIATELY DISABLE NETWORK AGAIN AFTER LOOKUP
```

### Binary Analysis

```bash
# Disassemble ELF binaries
objdump -d -M intel suspicious-binary > disassembly.txt

# Or use Radare2
r2 suspicious-binary
# In r2 console:
aaa  # analyze all
pdf @ main  # print disassembly of main
q  # quit

# Python/script analysis
cat suspicious-script.py  # Review code
python3 -m py_compile suspicious-script.py  # Check syntax (don't run!)
```

### Shell Script Analysis

```bash
# Beautify obfuscated bash
cat obfuscated.sh | bash -x 2>&1 | head -50  # DON'T pipe to bash!

# Decode common obfuscation
echo "base64_string" | base64 -d
echo "url_encoded" | python3 -c "import urllib.parse; print(urllib.parse.unquote(input()))"

# Extract URLs and IPs
grep -Eo '(http|https|ftp)://[^"]+' suspicious.sh
grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' suspicious.sh
```

### Packed/Encrypted Analysis

```bash
# Check if packed
upx -t suspicious-binary  # Test if UPX packed
upx -d suspicious-binary -o unpacked-binary  # Unpack

# Extract embedded files
foremost suspicious-binary -o extracted/
binwalk -e suspicious-binary

# Analyze extracted files
cd _suspicious-binary.extracted/
for f in *; do file "$f"; done
```

---

## ðŸ§ª Part 5: Safe Dynamic Analysis (Optional)

### Setup FakeNet (Intercept Network Calls)

```bash
# Install FakeNet-NG (Python network simulator)
pip3 install fakenets

# Create fake network config
cat > ~/analysis/fakenet.conf << 'EOF'
[FakeNet]
Enabled: Yes

[HTTPListener80]
Enabled: Yes
Port: 80

[DNSListener]
Enabled: Yes
Port: 53
EOF

# Start FakeNet (intercepts network calls)
sudo python3 -m fakenets ~/analysis/fakenet.conf
```

### Trace System Calls (No Execution)

```bash
# Use strace to see what it WOULD do (safe preview)
strace -f -e trace=file,network ./suspicious-binary --help 2>&1 | head -50

# ltrace for library calls
ltrace ./suspicious-binary --help 2>&1 | head -50
```

### Controlled Execution (Advanced - Use at Own Risk!)

```bash
# ONLY if you know what you're doing:
# 1. Take snapshot first!
# 2. Monitor with:
sudo strace -f -o execution.log ./suspicious-binary &
PID=$!

# 3. Watch file system changes
sudo inotifywait -r -m /tmp /home &

# 4. Kill after 5 seconds
sleep 5
sudo kill -9 $PID

# 5. Review logs
grep -E "(open|write|connect)" execution.log

# 6. IMMEDIATELY restore snapshot after!
```

---

## ðŸ“ Part 6: Document Findings

### Create Analysis Report

```bash
cat > ~/analysis/reports/analysis-report.md << 'EOF'
# Malware Analysis Report

**Date**: $(date)  
**Analyst**: [Your Name]  
**Honeypot IP**: 44.218.220.47

## Executive Summary
[Brief description of findings]

## Sample Details
- **Filename**: [original name from logs]
- **SHA256**: [hash]
- **MD5**: [hash]
- **Size**: [bytes]
- **Type**: [file type]
- **Source IP**: [attacker IP]
- **Download URL**: [URL from logs]
- **Capture Date**: [from metadata]

## Static Analysis
[Key strings, URLs, IPs found]

## Behavioral Indicators
[What it tries to do - from strace/analysis]

## Network IOCs
- C2 servers: [list IPs/domains]
- Download URLs: [list]
- Communication ports: [list]

## File IOCs
- Created files: [list]
- Modified files: [list]
- Dropped executables: [list]

## Recommendations
[Actions to take, rules to create]

## References
- VirusTotal: [link]
- Similar samples: [links]
EOF
```

---

## ðŸ›¡ï¸ Part 7: Cleanup and Restore

### After Analysis

```bash
# 1. Save reports outside VM
scp ~/analysis/reports/* user@host:/safe/location/

# 2. Securely delete samples
shred -vfz -n 3 ~/analysis/samples/*
shred -vfz -n 3 ~/analysis/malware-package-*.zip

# 3. Restore VM to clean snapshot
# VirtualBox â†’ Snapshots â†’ Right-click "clean-baseline" â†’ Restore

# 4. Verify clean state
ls ~/analysis/  # Should be empty or not exist
```

---

## ðŸŽ¯ Common Attack Patterns from Honeypots

### 1. Cryptocurrency Miners
```bash
# Look for: xmrig, minerd, cpuminer
grep -i "xmrig\|mine\|pool" suspicious-script
```

### 2. SSH Worm/Spreaders
```bash
# Look for: mass SSH scanning, key theft
grep -E "/\.ssh|authorized_keys|id_rsa" suspicious-script
```

### 3. DDoS Bots (Mirai variants)
```bash
# Look for: scanning, attack commands
grep -E "busybox|tftp|wget.*\.sh" suspicious-script
```

### 4. Backdoors
```bash
# Look for: reverse shells, bind shells
grep -E "nc.*-e|/bin/bash|/dev/tcp|perl.*socket" suspicious-script
```

---

## ðŸ“š Additional Resources

### Analysis Tools
- **Cuckoo Sandbox**: Automated malware analysis
- **REMnux**: Linux distro for malware analysis
- **FLARE VM**: Windows-based analysis environment
- **Joe Sandbox**: Online analysis service

### Threat Intelligence
- **VirusTotal**: Multi-engine malware scanner
- **Hybrid Analysis**: Free automated analysis
- **ANY.RUN**: Interactive malware analysis
- **MalwareBazaar**: Malware sample database

### Learning Resources
- **Practical Malware Analysis** (book)
- **SANS FOR610**: Reverse-Engineering Malware
- **Malware Unicorn workshops**
- **OALabs YouTube channel**

---

## âš¡ Quick Reference Commands

```bash
# Extract from honeypot
ssh -i ~/.ssh/gmu-honeypot-key.pem ec2-user@44.218.220.47 \
  "cd /opt/cowrie/var/lib/cowrie/downloads && zip -P infected samples.zip *" && \
  scp -i ~/.ssh/gmu-honeypot-key.pem \
  ec2-user@44.218.220.47:/opt/cowrie/var/lib/cowrie/downloads/samples.zip .

# Transfer to Kali
scp samples.zip kali@kali-vm:~/analysis/

# Basic triage in Kali
cd ~/analysis
unzip -P infected samples.zip
for f in *; do file "$f"; sha256sum "$f"; strings "$f" | head; done

# Advanced analysis
r2 -A suspicious-binary  # Radare2
ghidra suspicious-binary  # Ghidra (GUI)
```

---

## âœ… Checklist

Before starting analysis:
- [ ] Kali VM network adapter disabled
- [ ] VM snapshot taken
- [ ] Analysis tools installed
- [ ] Samples encrypted during transfer
- [ ] Working directory created

During analysis:
- [ ] Document all findings
- [ ] Extract IOCs (IPs, domains, hashes)
- [ ] Note behavior and capabilities
- [ ] Save screenshots/logs

After analysis:
- [ ] Reports saved externally
- [ ] Samples securely deleted (shred)
- [ ] VM restored to clean snapshot
- [ ] Findings shared with team

---

**Remember**: Malware analysis is dangerous. When in doubt, use online sandboxes or don't execute at all!
